- name: Configure Web Servers - Nginx and Docker
  hosts: webservers
  become: yes
  vars:
    nginx_user: www-data
    nginx_worker_processes: auto
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - git
          - ca-certificates
          - gnupg
          - lsb-release
          - software-properties-common
          - apt-transport-https
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install Python3 and pip
      apt:
        name:
          - python3
          - python3-pip
          - python3-setuptools
        state: present
      when: ansible_os_family == "Debian"

    - name: Install Docker
      block:
        - name: Remove old Docker packages if they exist
          apt:
            name:
              - docker
              - docker.io
              - docker-doc
              - docker-compose
              - docker-compose-v2
              - podman-docker
              - containerd
              - runc
            state: absent
            purge: yes
          ignore_errors: yes

        - name: Install prerequisites for Docker
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
            state: present
            update_cache: yes

        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose-plugin
            state: present
            update_cache: yes

        - name: Configure containerd
          shell: |
            mkdir -p /etc/containerd
            containerd config default | tee /etc/containerd/config.toml
          args:
            creates: /etc/containerd/config.toml
          changed_when: false

        - name: Restart containerd service
          systemd:
            name: containerd
            state: restarted
            enabled: yes

        - name: Start and enable Docker service
          systemd:
            name: docker
            state: started
            enabled: yes
            daemon_reload: yes

        - name: Wait for Docker daemon to be ready
          wait_for:
            path: /var/run/docker.sock
            state: present
            timeout: 30

        - name: Add user to docker group
          user:
            name: "{{ ansible_user | default(ansible_env.USER) | default('root') }}"
            groups: docker
            append: yes

    - name: Install Nginx
      block:
        - name: Install Nginx
          apt:
            name: nginx
            state: present
            update_cache: yes

        - name: Start and enable Nginx service
          systemd:
            name: nginx
            state: started
            enabled: yes

        - name: Configure Nginx basic settings
          template:
            src: nginx.conf.j2
            dest: /etc/nginx/nginx.conf
            backup: yes
          notify: restart nginx

        - name: Create Nginx web directory
          file:
            path: /var/www/html
            state: directory
            mode: '0755'
            owner: "{{ nginx_user }}"
            group: "{{ nginx_user }}"

    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Verify Nginx installation
      command: nginx -v
      register: nginx_version
      changed_when: false
      failed_when: false

    - name: Display installation status
      debug:
        msg:
          - "✅ Docker installed: {{ docker_version.stdout }}"
          - "✅ Nginx installed: {{ nginx_version.stderr | default(nginx_version.stdout) }}"

  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted

- name: Configure Application Servers - Node.js and Docker
  hosts: appservers
  become: yes
  vars:
    nodejs_version: "20.x"
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - git
          - build-essential
          - ca-certificates
          - gnupg
          - lsb-release
          - software-properties-common
          - apt-transport-https
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install Python3 and pip
      apt:
        name:
          - python3
          - python3-pip
          - python3-setuptools
        state: present
      when: ansible_os_family == "Debian"

    - name: Install Node.js via NodeSource repository
      block:
        - name: Create directory for keys
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'

        - name: Add NodeSource GPG key
          get_url:
            url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
            dest: /etc/apt/keyrings/nodesource.gpg
            mode: '0644'

        - name: Add NodeSource repository
          apt_repository:
            repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main"
            state: present
            filename: nodesource

        - name: Install Node.js
          apt:
            name: nodejs
            state: present
            update_cache: yes

        - name: Verify Node.js installation
          command: node --version
          register: node_check
          changed_when: false
          failed_when: node_check.rc != 0

        - name: Install npm globally (if not included)
          npm:
            name: npm
            global: yes
            state: present
          when: node_check.rc == 0

    - name: Install Docker
      block:
        - name: Remove old Docker packages if they exist
          apt:
            name:
              - docker
              - docker.io
              - docker-doc
              - docker-compose
              - docker-compose-v2
              - podman-docker
              - containerd
              - runc
            state: absent
            purge: yes
          ignore_errors: yes

        - name: Install prerequisites for Docker
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
            state: present
            update_cache: yes

        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose-plugin
            state: present
            update_cache: yes

        - name: Configure containerd
          shell: |
            mkdir -p /etc/containerd
            containerd config default | tee /etc/containerd/config.toml
          args:
            creates: /etc/containerd/config.toml
          changed_when: false

        - name: Restart containerd service
          systemd:
            name: containerd
            state: restarted
            enabled: yes

        - name: Start and enable Docker service
          systemd:
            name: docker
            state: started
            enabled: yes
            daemon_reload: yes

        - name: Wait for Docker daemon to be ready
          wait_for:
            path: /var/run/docker.sock
            state: present
            timeout: 30

        - name: Add user to docker group
          user:
            name: "{{ ansible_user | default(ansible_env.USER) | default('root') }}"
            groups: docker
            append: yes

    - name: Install PM2 globally (Node.js process manager)
      npm:
        name: pm2
        global: yes
        state: present

    - name: Create application directory
      file:
        path: /opt/todo-app
        state: directory
        mode: '0755'

    - name: Verify Node.js installation
      command: node --version
      register: node_version
      changed_when: false

    - name: Verify npm installation
      command: npm --version
      register: npm_version
      changed_when: false

    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Display installation status
      debug:
        msg:
          - "✅ Node.js installed: {{ node_version.stdout }}"
          - "✅ npm installed: {{ npm_version.stdout }}"
          - "✅ Docker installed: {{ docker_version.stdout }}"

- name: Configure Database Servers - MongoDB and Docker
  hosts: dbservers
  become: yes
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - gnupg
          - ca-certificates
          - software-properties-common
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install Python3
      apt:
        name:
          - python3
          - python3-pip
        state: present
      when: ansible_os_family == "Debian"

    - name: Install Docker
      block:
        - name: Remove old Docker packages if they exist
          apt:
            name:
              - docker
              - docker.io
              - docker-doc
              - docker-compose
              - docker-compose-v2
              - podman-docker
              - containerd
              - runc
            state: absent
            purge: yes
          ignore_errors: yes

        - name: Install prerequisites for Docker
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
            state: present
            update_cache: yes

        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose-plugin
            state: present
            update_cache: yes

        - name: Configure containerd
          shell: |
            mkdir -p /etc/containerd
            containerd config default | tee /etc/containerd/config.toml
          args:
            creates: /etc/containerd/config.toml
          changed_when: false

        - name: Restart containerd service
          systemd:
            name: containerd
            state: restarted
            enabled: yes

        - name: Start and enable Docker service
          systemd:
            name: docker
            state: started
            enabled: yes
            daemon_reload: yes

        - name: Wait for Docker daemon to be ready
          wait_for:
            path: /var/run/docker.sock
            state: present
            timeout: 30

        - name: Add user to docker group
          user:
            name: "{{ ansible_user | default(ansible_env.USER) | default('root') }}"
            groups: docker
            append: yes

    - name: Create MongoDB data directory
      file:
        path: /data/db
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Display installation status
      debug:
        msg:
          - "✅ Docker installed: {{ docker_version.stdout }}"
          - "✅ MongoDB data directory created: /data/db"

- name: Configure Kubernetes Nodes - kubectl and Docker
  hosts: kubernetes
  become: yes
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - git
          - ca-certificates
          - gnupg
          - lsb-release
          - software-properties-common
          - apt-transport-https
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install Python3
      apt:
        name:
          - python3
          - python3-pip
        state: present
      when: ansible_os_family == "Debian"

    - name: Install Docker
      block:
        - name: Remove old Docker packages if they exist
          apt:
            name:
              - docker
              - docker.io
              - docker-doc
              - docker-compose
              - docker-compose-v2
              - podman-docker
              - containerd
              - runc
            state: absent
            purge: yes
          ignore_errors: yes

        - name: Install prerequisites for Docker
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
            state: present
            update_cache: yes

        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose-plugin
            state: present
            update_cache: yes

        - name: Configure containerd
          shell: |
            mkdir -p /etc/containerd
            containerd config default | tee /etc/containerd/config.toml
          args:
            creates: /etc/containerd/config.toml
          changed_when: false

        - name: Restart containerd service
          systemd:
            name: containerd
            state: restarted
            enabled: yes

        - name: Start and enable Docker service
          systemd:
            name: docker
            state: started
            enabled: yes
            daemon_reload: yes

        - name: Wait for Docker daemon to be ready
          wait_for:
            path: /var/run/docker.sock
            state: present
            timeout: 30

        - name: Add user to docker group
          user:
            name: "{{ ansible_user | default(ansible_env.USER) | default('root') }}"
            groups: docker
            append: yes

    - name: Install kubectl
      block:
        - name: Download kubectl binary
          get_url:
            url: https://dl.k8s.io/release/v1.33.5/bin/linux/amd64/kubectl
            dest: /usr/local/bin/kubectl
            mode: '0755'

        - name: Verify kubectl installation
          command: kubectl version --client
          register: kubectl_version
          changed_when: false

    - name: Verify Docker installation
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Display installation status
      debug:
        msg:
          - "✅ Docker installed: {{ docker_version.stdout }}"
          - "✅ kubectl installed: {{ kubectl_version.stdout }}"
