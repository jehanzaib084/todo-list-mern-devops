name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üèóÔ∏è Build Frontend
        run: |
          echo "Building Frontend..."
          cd Client
          npm ci
          npm run build

      - name: üèóÔ∏è Build Backend
        run: |
          echo "Building Backend..."
          cd Server
          npm ci
          node --check server.js && echo "‚úÖ Backend syntax valid"
          node --check config/db/DbCon.js && echo "‚úÖ Database config valid" || echo "‚ö†Ô∏è Config check skipped"

      - name: üß™ Run Tests
        run: |
          echo "Running tests..."
          cd Client
          npm run lint || echo "‚úÖ Lint completed (warnings allowed)"
          
          cd ../Server
          node --check server.js && echo "‚úÖ Backend syntax valid"
          node --check config/db/DbCon.js && echo "‚úÖ Database config valid" || echo "‚ö†Ô∏è Config check skipped"

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: üê≥ Build and Push Frontend Image
        run: |
          cd Client
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/todo-frontend:${{ env.IMAGE_TAG }} .
          docker tag ${{ env.DOCKERHUB_USERNAME }}/todo-frontend:${{ env.IMAGE_TAG }} ${{ env.DOCKERHUB_USERNAME }}/todo-frontend:latest
          docker push ${{ env.DOCKERHUB_USERNAME }}/todo-frontend:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKERHUB_USERNAME }}/todo-frontend:latest

      - name: üê≥ Build and Push Backend Image
        run: |
          cd Server
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/todo-backend:${{ env.IMAGE_TAG }} .
          docker tag ${{ env.DOCKERHUB_USERNAME }}/todo-backend:${{ env.IMAGE_TAG }} ${{ env.DOCKERHUB_USERNAME }}/todo-backend:latest
          docker push ${{ env.DOCKERHUB_USERNAME }}/todo-backend:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKERHUB_USERNAME }}/todo-backend:latest

      - name: üê≥ Build and Push Database Image
        run: |
          cd db
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/todo-db:${{ env.IMAGE_TAG }} .
          docker tag ${{ env.DOCKERHUB_USERNAME }}/todo-db:${{ env.IMAGE_TAG }} ${{ env.DOCKERHUB_USERNAME }}/todo-db:latest
          docker push ${{ env.DOCKERHUB_USERNAME }}/todo-db:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKERHUB_USERNAME }}/todo-db:latest

      - name: ‚ò∏Ô∏è Setup kubectl
        uses: azure/setup-kubectl@v3
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

      - name: ‚ò∏Ô∏è Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

      - name: ‚ò∏Ô∏è Deploy to Kubernetes
        run: |
          echo "Deploying to Kubernetes..."
          kubectl apply -f k8s/namespace.yaml || kubectl create namespace todo-app || true
          
          # Create Docker Hub secret if it doesn't exist
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_PASSWORD }} \
            --namespace=todo-app \
            --dry-run=client -o yaml | kubectl apply -f - || true
          
          # Apply all Kubernetes manifests
          kubectl apply -f k8s/mongodb.yaml
          kubectl apply -f k8s/backend.yaml
          kubectl apply -f k8s/frontend.yaml
          
          echo "‚úÖ Kubernetes manifests applied"
          echo ""
          echo "üìä Deployment Status:"
          kubectl get pods -n todo-app
          kubectl get svc -n todo-app
          
          # Get frontend external IP
          sleep 10
          EXTERNAL_IP=$(kubectl get svc frontend -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          EXTERNAL_HOSTNAME=$(kubectl get svc frontend -n todo-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          
          if [ -n "$EXTERNAL_IP" ]; then
            echo "‚úÖ Frontend External IP: http://${EXTERNAL_IP}"
          elif [ -n "$EXTERNAL_HOSTNAME" ]; then
            echo "‚úÖ Frontend External Hostname: http://${EXTERNAL_HOSTNAME}"
          else
            echo "‚è≥ LoadBalancer IP is still provisioning..."
          fi
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

      - name: üìä Final Status
        run: |
          echo "‚úÖ Pipeline completed successfully!"
          echo "Images pushed:"
          echo "  - ${{ env.DOCKERHUB_USERNAME }}/todo-frontend:${{ env.IMAGE_TAG }}"
          echo "  - ${{ env.DOCKERHUB_USERNAME }}/todo-backend:${{ env.IMAGE_TAG }}"
          echo "  - ${{ env.DOCKERHUB_USERNAME }}/todo-db:${{ env.IMAGE_TAG }}"
        if: success()
